<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
        // আপনার কনফিগ এখানে বসান...
        apiKey: "আপনার_API_KEY",
        authDomain: "ns-prime-d7ca5.firebaseapp.com",
        projectId: "ns-prime-d7ca5",
        storageBucket: "ns-prime-d7ca5.firebasestorage.app",
        messagingSenderId: "172231719671",
        appId: "1:172231719671:web:3dafc0ace7b44fbe0071f2",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function trackVisit() {
        const urlParams = new URLSearchParams(window.location.search);
        const refUid = urlParams.get('ref');

        if (!refUid) return; // রেফারেন্স না থাকলে কিছু করার দরকার নেই

        try {
            // ১. সেটিংস থেকে রিওয়ার্ড অ্যামাউন্ট এবং মেইনটেইনেন্স চেক করা
            const settingsRef = doc(db, "settings", "config");
            let viewRewardAmount = 0.05; // ডিফল্ট ভ্যালু (যদি সেটিংস লোড না হয়)
            
            try {
                const settingsSnap = await getDoc(settingsRef);
                if (settingsSnap.exists()) {
                    const data = settingsSnap.data();
                    
                    // মেইনটেইনেন্স মোড অন থাকলে ট্র্যাকিং বন্ধ থাকবে
                    if (data.maintenance === true) {
                        console.log("Site is in maintenance mode");
                        return;
                    }

                    // আপনার ডাটাবেসে ফিল্ডের নাম 'viewReward' (স্ক্রিনশট অনুযায়ী)
                    // এটি নিশ্চিত করে যে এটি নাম্বার হিসেবে আসছে
                    viewRewardAmount = Number(data.viewReward) || 0.05; 
                }
            } catch (err) {
                console.log("Settings fetching failed, using default reward.");
            }

            // ২. ইউজারের একাউন্টে আপডেট করা
            const userRef = doc(db, "users", refUid);
            await updateDoc(userRef, {
                rawTodayImpressions: increment(1),
                todayEarning: increment(viewRewardAmount),
                totalEarnings: increment(viewRewardAmount),
                balance: increment(viewRewardAmount)
            });

            console.log("Tracking Success! Added:", viewRewardAmount);

        } catch (error) {
            console.error("Tracking Error:", error);
        }
    }

    // পেজ লোড হলে ফাংশন কল হবে
    window.onload = trackVisit;
</script>
