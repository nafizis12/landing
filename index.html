<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NS PRIME - Redirecting...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #020617; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #0f172a; padding: 30px; border-radius: 16px; border: 1px solid #1e293b; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 0 30px rgba(0, 243, 255, 0.1); }
        .loader { width: 40px; height: 40px; border: 4px solid #334155; border-top: 4px solid #00f3ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-action { background: linear-gradient(90deg, #00f3ff, #0066ff); color: black; font-weight: bold; padding: 12px 30px; border-radius: 8px; margin-top: 20px; width: 100%; display: block; text-transform: uppercase; cursor: pointer; border: none; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="card">
    <h2 class="text-2xl font-bold mb-2">NS <span class="text-cyan-400">PRIME</span></h2>
    <div id="status-area">
        <div class="loader"></div>
        <p class="text-gray-400 text-sm animate-pulse">Checking Link Safety...</p>
    </div>

    <!-- ভিজিটর ক্লিক করলে টাকা যোগ হবে -->
    <div id="action-area" class="hidden">
        <p class="text-gray-300 text-sm mb-4">Content is ready to view.</p>
        <button id="final-btn" class="btn-action">CONTINUE TO CONTENT <i class="fas fa-arrow-right ml-2"></i></button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // ⚡ FIREBASE CONFIG (আপনার অ্যাডমিন প্যানেলের কনফিগারেশন দিন)
    const firebaseConfig = {
        apiKey: "AIzaSyCU2RfLeclEyyxzEActtl5ks1P_NPvATOE",
        authDomain: "ns-prime-d7ca5.firebaseapp.com",
        projectId: "ns-prime-d7ca5",
        storageBucket: "ns-prime-d7ca5.firebasestorage.app",
        messagingSenderId: "172231719671",
        appId: "1:172231719671:web:3dafc0ace7b44fbe0071f2",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // URL থেকে ইউজারের UID বের করা
    const urlParams = new URLSearchParams(window.location.search);
    const refUid = urlParams.get('ref');
    const contentType = urlParams.get('type') || 'video';

    // ফাইনাল গন্তব্য (উদাহরণ)
    const destinations = {
        'video': 'https://youtube.com',
        'job': 'https://bdjobs.com',
        'money': 'https://google.com'
    };
    const finalLink = destinations[contentType] || 'https://google.com';

    async function init() {
        if (!refUid) {
            window.location.href = finalLink; // রেফার কোড না থাকলে ডাইরেক্ট পাঠিয়ে দিবে
            return;
        }

        try {
            // ১. ইম্প্রেশন কাউন্ট করা (পেজ লোড হওয়ার সাথে সাথে)
            const userRef = doc(db, "users", refUid);
            await updateDoc(userRef, {
                rawTotalImpressions: increment(1),
                rawTodayImpressions: increment(1)
            });

            // ২. UI আপডেট
            setTimeout(() => {
                document.getElementById('status-area').classList.add('hidden');
                document.getElementById('action-area').classList.remove('hidden');
            }, 2000); // ২ সেকেন্ড লোডিং দেখাবে

        } catch (error) {
            console.error("Tracking Error:", error);
            window.location.href = finalLink;
        }
    }

    // ৩. বাটন ক্লিক হ্যান্ডলার (টাকা এবং ক্লিক যোগ হবে এখানে)
    document.getElementById('final-btn').onclick = async function() {
        const btn = document.getElementById('final-btn');
        btn.innerHTML = "VERIFYING...";
        btn.disabled = true;

        if (refUid) {
            try {
                // অ্যাডমিন প্যানেল থেকে CPM রেট নিয়ে আসা
                const settingsSnap = await getDoc(doc(db, "settings", "general"));
                let cpm = 100; // ডিফল্ট
                let cut = 10;  // ডিফল্ট ইম্প্রেশন কাট

                if(settingsSnap.exists()) {
                    cpm = settingsSnap.data().cpm || 100;
                    cut = settingsSnap.data().impressionPercentage || 10;
                }

                // প্রতি ক্লিকে কত টাকা পাবে? (CPM / 1000 * 10) - উদাহরণস্বরূপ লজিক
                // অথবা সিম্পল লজিক: 1000 ক্লিকে CPM এমাউন্ট। তাহলে 1 ক্লিকে = CPM / 1000
                const earningPerClick = cpm / 1000; 

                // ডাটাবেস আপডেট (টাকা + ক্লিক)
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", refUid);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) return;

                    transaction.update(userRef, {
                        rawTotalClicks: increment(1),
                        rawTodayClicks: increment(1), // লাইভ ট্রাফিক CTR এর জন্য জরুরি
                        balance: increment(earningPerClick),
                        todayEarning: increment(earningPerClick),
                        totalEarnings: increment(earningPerClick)
                    });
                });

            } catch (e) {
                console.log("Update failed but redirecting...");
            }
        }

        // ৪. ফাইনাল রিডাইরেক্ট
        window.location.href = finalLink;
    };

    // স্টার্ট
    init();

</script>
</body>
</html>
